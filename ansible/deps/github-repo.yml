---
- name: Set up temporary repo dir
  set_fact:
    repo_tmp_dir: "{{ tmp_dir }}/{{ repo | regex_replace('/', '_') }}"

- name: Ensure repo tmp dir exists
  file:
    path: "{{ repo_tmp_dir }}"
    state: directory

- name: Get latest release tag
  command: gh release view --repo {{ repo }} --json tagName --jq .tagName
  register: release_tag
  changed_when: false

- name: Print release version
  debug:
    msg: "Installing {{ binary_name }} from {{ repo }} version {{ release_tag.stdout }}"

- name: Download latest release asset
  command: >
    gh release download
    --repo {{ repo }}
    --pattern "{{ asset_pattern }}"
    --dir {{ repo_tmp_dir }}
    --clobber
  register: gh_download
  changed_when: false

- name: Find downloaded files
  find:
    paths: "{{ repo_tmp_dir }}"
    recurse: no
  register: found_files

- name: Identify exact asset match (if pattern is exact filename)
  set_fact:
    asset_exact_match: >-
      {{ found_files.files
         | selectattr('path', 'search', '/' + (asset_pattern | regex_escape) + '$')
         | list | first | default(omit) }}
  when:
    - asset_pattern is not match('.*[\\*\\?].*')

- name: Collect archive candidates
  set_fact:
    archive_candidates: >-
      {{ found_files.files
         | selectattr('path', 'search', '.tar.gz$|.tgz$|.zip$|.tar.xz$')
         | list }}

- name: Identify archive file
  set_fact:
    archive_file: "{{ archive_candidates | first }}"
  when: archive_candidates | length > 0

- name: Collect direct download candidates
  set_fact:
    direct_download_candidates: >-
      {{ found_files.files
         | rejectattr('path', 'search', '.tar.gz$|.zip$|.tgz$|.tar.xz$|.sha256$|.sha$')
         | list }}

- name: Identify direct download (non-archive)
  set_fact:
    direct_download: "{{ direct_download_candidates | first }}"
  when: direct_download_candidates | length > 0

- name: Stat direct download (detect mime)
  stat:
    path: "{{ direct_download.path }}"
    get_mime: true
  register: direct_download_stat
  when: direct_download is defined

- name: Fail if direct download is not a binary
  fail:
    msg: >-
      Expected a binary for {{ binary_name }}, but got
      {{ direct_download_stat.stat.mime_type | default('unknown') }} at {{ direct_download.path }}.
  when:
    - direct_download is defined
    - direct_download_stat.stat.mime_type is defined
    - direct_download_stat.stat.mime_type is match('^text/')
    - archive_file is not defined

- name: Decompress gzip if needed
  command: >
    gzip -d -c {{ direct_download.path }} > {{ repo_tmp_dir }}/{{ binary_name }}
  args:
    creates: "{{ repo_tmp_dir }}/{{ binary_name }}"
  when:
    - direct_download is defined
    - direct_download_stat.stat.mime_type is defined
    - direct_download_stat.stat.mime_type is match('application/(x-)?gzip')

- name: Check for decompressed binary
  stat:
    path: "{{ repo_tmp_dir }}/{{ binary_name }}"
  register: decompressed_stat

- name: Extract archive if present
  when: archive_file is defined
  unarchive:
    src: "{{ archive_file.path }}"
    dest: "{{ repo_tmp_dir }}"
    remote_src: true

# ðŸ§© Find actual binary only (exclude archives)
- name: Find binary (inside archive or directly)
  find:
    paths: "{{ repo_tmp_dir }}"
    recurse: yes
    patterns: "{{ binary_name }}*"
    file_type: file
  register: found_bin

- name: Filter out any archives or checksum files
  set_fact:
    real_bin: >-
      {{ found_bin.files
         | rejectattr('path', 'search', '.tar.gz$|.zip$|.tgz$|.tar.xz$|.sha256$|.sha$')
         | list | first | default(omit) }}

- name: Prefer exact asset match when available
  set_fact:
    real_bin:
      path: "{{ asset_exact_match.path }}"
  when:
    - asset_exact_match is defined
    - archive_file is not defined

- name: Override real binary with decompressed file
  set_fact:
    real_bin:
      path: "{{ repo_tmp_dir }}/{{ binary_name }}"
  when:
    - decompressed_stat.stat.exists | default(false)

- name: Debug (optional)
  debug:
    msg: "Found real binary: {{ real_bin.path | default('none') }}"

- name: Fail if neither archive nor binary is found
  fail:
    msg: >-
      No usable archive or binary found for {{ binary_name }} in {{ repo_tmp_dir }}.
  when:
    - archive_file is not defined
    - real_bin is not defined

- name: Install binary (renamed to short name)
  copy:
    src: "{{ real_bin.path }}"
    dest: "{{ download_dir }}/{{ binary_name }}"
    mode: "0755"
    force: true
  when: real_bin is defined

- name: Confirm installation
  debug:
    msg: "âœ… Installed {{ binary_name }} {{ release_tag.stdout }} to {{ download_dir }}"
