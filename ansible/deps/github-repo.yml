---
- name: Set up temporary repo dir
  set_fact:
    repo_tmp_dir: "{{ tmp_dir }}/{{ repo | regex_replace('/', '_') }}"

- name: Ensure repo tmp dir exists
  file:
    path: "{{ repo_tmp_dir }}"
    state: directory

- name: Get latest release tag
  command: gh release view --repo {{ repo }} --json tagName --jq .tagName
  register: release_tag
  changed_when: false

- name: Print release version
  debug:
    msg: "Installing {{ binary_name }} from {{ repo }} version {{ release_tag.stdout }}"

- name: Download latest release asset
  command: >
    gh release download
    --repo {{ repo }}
    --pattern "{{ asset_pattern }}"
    --dir {{ repo_tmp_dir }}
    --clobber
  register: gh_download
  changed_when: false

- name: Find downloaded files
  find:
    paths: "{{ repo_tmp_dir }}"
    recurse: no
  register: found_files

- name: Identify archive file
  set_fact:
    archive_file: >-
      {{ found_files.files
         | selectattr('path', 'search', '.tar.gz$|.tgz$|.zip$|.tar.xz$')
         | list | first | default(omit) }}

- name: Extract archive if present
  when: archive_file is defined
  unarchive:
    src: "{{ archive_file.path }}"
    dest: "{{ repo_tmp_dir }}"
    remote_src: true

# ðŸ§© Find actual binary only (exclude archives)
- name: Find binary (inside archive or directly)
  find:
    paths: "{{ repo_tmp_dir }}"
    recurse: yes
    patterns: "{{ binary_name }}*"
    file_type: file
  register: found_bin

- name: Filter out any archives or checksum files
  set_fact:
    real_bin: >-
      {{ found_bin.files
         | rejectattr('path', 'search', '.tar.gz$|.zip$|.tgz$|.tar.xz$|.sha256$|.sha$')
         | list | first | default(omit) }}

- name: Debug (optional)
  debug:
    msg: "Found real binary: {{ real_bin.path | default('none') }}"

- name: Install binary (renamed to short name)
  copy:
    src: "{{ real_bin.path }}"
    dest: "{{ download_dir }}/{{ binary_name }}"
    mode: "0755"
    force: true
  when: real_bin is defined

- name: Confirm installation
  debug:
    msg: "âœ… Installed {{ binary_name }} {{ release_tag.stdout }} to {{ download_dir }}"
